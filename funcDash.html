<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Funcionário</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">F</div>
                <div>
                    <h2 id="userGreeting">Olá, Funcionário</h2>
                    <p id="userRole">Funcionário</p>
                </div>
            </div>
            <button id="logoutBtn" class="btn logout-btn">Sair</button>
        </div>
        
        <div class="dashboard-content">
            <div class="content-header">
                <h2 id="contentTitle">Meus Itens</h2>
            </div>
            <div id="contentArea">
                <p>Carregando seus checklists e feedbacks...</p>
            </div>
        </div>
    </div>

    <script src="index.js"></script>
    <script>
        // Inicialização específica para funcionário
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado - inicializando dashboard do funcionário');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser || currentUser.role !== 'Funcionário') {
                window.location.href = 'login.html';
                return;
            }

            // Configurar informações do usuário
            document.getElementById('userGreeting').textContent = `Olá, ${currentUser.name}`;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            });
            
            // Carregar dados
            loadUserItems();
        });

        async function loadUserItems() {
            const contentArea = document.getElementById('contentArea');
            const contentTitle = document.getElementById('contentTitle');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            contentTitle.textContent = `Meus Itens - ${currentUser.name}`;
            
            try {
                const [checklistsResponse, feedbacksResponse] = await Promise.all([
                    fetch('http://18.212.217.221:3000/api/checklists'),
                    fetch('http://18.212.217.221:3000/api/feedbacks')
                ]);

                const checklists = await checklistsResponse.json();
                const feedbacks = await feedbacksResponse.json();

                const userChecklists = Array.isArray(checklists) ? checklists.filter(c => c.assignee === currentUser.name) : [];
                const userFeedbacks = Array.isArray(feedbacks) ? feedbacks.filter(f => f.assignee === currentUser.name) : [];

                updateUserInterface(userChecklists, userFeedbacks, currentUser);

            } catch (error) {
                console.error('Erro ao carregar itens do usuário:', error);
                contentArea.innerHTML = '<p>Erro ao carregar seus itens.</p>';
            }
        }

        function updateUserInterface(userChecklists, userFeedbacks, currentUser) {
            const contentArea = document.getElementById('contentArea');
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="margin-bottom: 15px; color: #2575fc;">Meus Checklists (${userChecklists.length})</h3>
            `;
            
            if (userChecklists.length === 0) {
                html += '<p style="color: #666; font-style: italic;">Nenhum checklist atribuído a você.</p>';
            } else {
                html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                userChecklists.forEach(checklist => {
                    const completedItems = checklist.itemsCompleted ? checklist.itemsCompleted.length : 0;
                    const totalItems = checklist.items ? checklist.items.length : 0;
                    const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                    
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #2575fc; cursor: pointer;" 
                             onclick="openChecklistDetail(${checklist.id})">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #333;">${checklist.title}</strong>
                                <span class="status-badge ${checklist.completed ? 'status-completed' : 'status-pending'}">
                                    ${checklist.completed ? 'Concluído' : `${progress}%`}
                                </span>
                            </div>
                            ${checklist.description ? `<p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">${checklist.description}</p>` : ''}
                            
                            <!-- Barra de progresso -->
                            <div style="margin: 10px 0;">
                                <div style="background: #e9ecef; border-radius: 10px; height: 8px; overflow: hidden;">
                                    <div style="background: #28a745; height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 5px;">
                                    <span>${completedItems}/${totalItems} itens</span>
                                    <span>${progress}% concluído</span>
                                </div>
                            </div>
                            
                            <div style="font-size: 12px; color: #999;">
                                Criado em: ${new Date(checklist.date).toLocaleDateString()}
                                ${checklist.completedDate ? ` • Concluído em: ${new Date(checklist.completedDate).toLocaleDateString()}` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += `
                    </div>
                    <div>
                        <h3 style="margin-bottom: 15px; color: #28a745;">Meus Feedbacks (${userFeedbacks.length})</h3>
            `;
            
            if (userFeedbacks.length === 0) {
                html += '<p style="color: #666; font-style: italic;">Nenhum feedback recebido.</p>';
            } else {
                html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                userFeedbacks.forEach(feedback => {
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #28a745;">
                            <strong style="color: #333; display: block; margin-bottom: 8px;">${feedback.title}</strong>
                            <p style="margin: 0 0 8px 0; color: #666; font-size: 14px; line-height: 1.4;">${feedback.message}</p>
                            <div style="font-size: 12px; color: #999;">
                                Recebido em: ${new Date(feedback.date).toLocaleDateString()}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div></div>';
            contentArea.innerHTML = html;
        }

        // Função para abrir modal de detalhes do checklist
        async function openChecklistDetail(checklistId) {
            try {
                const response = await fetch('http://18.212.217.221:3000/api/checklists');
                const checklists = await response.json();
                const checklist = checklists.find(c => c.id === checklistId);
                
                if (!checklist) {
                    alert('Checklist não encontrado');
                    return;
                }

                // Inicializar itemsCompleted se não existir
                if (!checklist.itemsCompleted) {
                    checklist.itemsCompleted = [];
                }

                const completedItems = checklist.itemsCompleted.length;
                const totalItems = checklist.items ? checklist.items.length : 0;
                const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;

                // Criar modal dinamicamente
                const modalHTML = `
                    <div id="checklistDetailModal" class="modal">
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="modal-header">
                                <h3>${checklist.title}</h3>
                                <button class="close-btn" id="closeChecklistDetailModal">&times;</button>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                ${checklist.description ? `<p style="color: #666; margin-bottom: 15px;">${checklist.description}</p>` : ''}
                                
                                <!-- Barra de progresso -->
                                <div style="background: #e9ecef; border-radius: 10px; height: 10px; overflow: hidden; margin-bottom: 10px;">
                                    <div style="background: #28a745; height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <strong>Progresso: ${completedItems}/${totalItems} itens</strong>
                                        <span style="margin-left: 10px; color: #28a745; font-weight: bold;">${progress}%</span>
                                    </div>
                                    <span class="status-badge ${checklist.completed ? 'status-completed' : 'status-pending'}">
                                        ${checklist.completed ? 'Concluído' : 'Em andamento'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label style="font-weight: bold; margin-bottom: 15px; display: block;">Itens do Checklist:</label>
                                <div id="checklistItemsList" style="display: flex; flex-direction: column; gap: 8px;">
                                    ${checklist.items && checklist.items.length > 0 ? 
                                        checklist.items.map((item, index) => {
                                            const isCompleted = checklist.itemsCompleted.includes(index);
                                            return `
                                                <div style="display: flex; align-items: flex-start; padding: 12px; background: ${isCompleted ? '#d4edda' : '#f8f9fa'}; border-radius: 8px; border-left: 4px solid ${isCompleted ? '#28a745' : '#6c757d'};">
                                                    <input type="checkbox" id="item-${index}" ${isCompleted ? 'checked' : ''} 
                                                           style="margin-right: 12px; margin-top: 2px; transform: scale(1.2);"
                                                           onchange="toggleChecklistItem(${checklistId}, ${index}, this.checked)">
                                                    <label for="item-${index}" style="flex: 1; cursor: pointer; ${isCompleted ? 'text-decoration: line-through; color: #6c757d;' : ''}">
                                                        <div style="font-weight: 500; margin-bottom: 4px;">${item}</div>
                                                        ${isCompleted ? `<div style="font-size: 11px; color: #28a745;">Concluído</div>` : ''}
                                                    </label>
                                                </div>
                                            `;
                                        }).join('') : 
                                        '<p style="color: #666; font-style: italic;">Nenhum item definido para este checklist.</p>'
                                    }
                                </div>
                            </div>
                            
                            <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #ddd;">
                                <div style="font-size: 12px; color: #999;">
                                    <strong>Informações:</strong><br>
                                    Atribuído a: ${checklist.assignee}<br>
                                    Criado em: ${new Date(checklist.date).toLocaleDateString()}<br>
                                    ${checklist.completedDate ? `Concluído em: ${new Date(checklist.completedDate).toLocaleDateString()}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Adicionar modal ao body
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Configurar eventos do modal
                const modal = document.getElementById('checklistDetailModal');
                const closeBtn = document.getElementById('closeChecklistDetailModal');
                
                // Fechar modal
                function closeModal() {
                    modal.remove();
                }
                
                closeBtn.addEventListener('click', closeModal);
                
                // Fechar ao clicar fora
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
            } catch (error) {
                console.error('Erro ao abrir detalhes do checklist:', error);
                alert('Erro ao carregar detalhes do checklist');
            }
        }

        // Função para alternar item individual do checklist
        async function toggleChecklistItem(checklistId, itemIndex, isCompleted) {
            try {
                const response = await fetch(`http://18.212.217.221:3000/api/checklists/${checklistId}/items`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        itemIndex: itemIndex,
                        completed: isCompleted
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Atualizar visualmente o item
                    const itemElement = document.querySelector(`#checklistDetailModal input[id="item-${itemIndex}"]`);
                    const labelElement = itemElement.nextElementSibling;
                    const itemContainer = itemElement.parentElement;
                    
                    if (isCompleted) {
                        itemContainer.style.background = '#d4edda';
                        itemContainer.style.borderLeftColor = '#28a745';
                        labelElement.style.textDecoration = 'line-through';
                        labelElement.style.color = '#6c757d';
                    } else {
                        itemContainer.style.background = '#f8f9fa';
                        itemContainer.style.borderLeftColor = '#6c757d';
                        labelElement.style.textDecoration = 'none';
                        labelElement.style.color = 'inherit';
                    }
                    
                    // Recarregar a lista para atualizar o progresso
                    setTimeout(() => {
                        loadUserItems();
                    }, 500);
                    
                } else {
                    alert('Erro ao atualizar item do checklist');
                    // Reverter o checkbox em caso de erro
                    const checkbox = document.querySelector(`#checklistDetailModal input[id="item-${itemIndex}"]`);
                    checkbox.checked = !isCompleted;
                }
            } catch (error) {
                console.error('Erro ao atualizar item:', error);
                alert('Erro ao atualizar item do checklist');
                // Reverter o checkbox em caso de erro
                const checkbox = document.querySelector(`#checklistDetailModal input[id="item-${itemIndex}"]`);
                checkbox.checked = !isCompleted;
            }
        }
    </script>
</body>

</html>
